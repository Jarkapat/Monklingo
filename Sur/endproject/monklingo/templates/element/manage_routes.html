{% extends 'base/base.html' %}
{% block main %}

<div class="flex-1 overflow-y-auto ml-[300px] mt-10">
  <h1 class="text-left text-3xl font-semibold my-6 noto">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡∏∞ Checkpoints</h1>
  <button class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring focus:ring-blue-300 noto">
  <a href="/routes">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</a>
  </button>
  <div class="bg-white shadow-md rounded-lg p-6 mt-6 max-w-2xl">
    <h2 class="text-xl font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©</h2>

    <form id="addEventForm">
        
        <label class="block text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î:</label>
        <select id="event_temple_select" onchange="fetchRoutes()" required class="border p-2 rounded-md w-full"></select>
        
        <label class="block text-gray-600 mb-2 mt-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
        <input type="date" id="event_date" required class="border p-2 rounded-md w-full">

        <label class="block text-gray-600 mt-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:</label>
        <select id="event_type" required class="border p-2 rounded-md w-full">
            <option value="buddhist_day">üìå ‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞</option>
            <option value="special_event">‚ö†Ô∏è ‡∏Å‡∏¥‡∏à‡∏ô‡∏¥‡∏°‡∏ô‡∏ï‡πå</option>
            <option value="weather">üåßÔ∏è ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</option>
            <option value="other">üóìÔ∏è ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <label class="block text-gray-600 mt-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
        <input type="text" id="event_description" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡∏∞‡∏ï‡∏¥‡∏î‡∏Å‡∏¥‡∏à‡∏ô‡∏¥‡∏°‡∏ô‡∏ï‡πå, ‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å" required class="border p-2 rounded-md w-full">

        <label class="block text-gray-600 mt-4">‡∏á‡∏î‡∏ö‡∏¥‡∏ì‡∏ë‡∏ö‡∏≤‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</label>
        <input type="checkbox" id="is_canceled" class="mr-2"> ‡πÉ‡∏ä‡πà (‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏û‡∏£‡∏∞‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏¥‡∏ì‡∏ë‡∏ö‡∏≤‡∏ï)

        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4">
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
        </button>
    </form>


<!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Event ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
<div class="bg-white shadow-md rounded-lg p-6 mt-6 max-w-2xl">
    <h2 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h2>
    <select id="event_temple_filter" onchange="fetchEvents()" class="border p-2 rounded-md w-full mb-4"></select>
    <ul id="event_list" class="space-y-2"></ul>
</div>
</div>
  <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î -->
    
  <div class="bg-white shadow-md rounded-lg p-6 mt-6 max-w-2xl">
    <h2 class="text-xl font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</h2>
    <input type="text" id="temple_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î" class="border p-2 rounded-md w-full">

    
    {% if not request.user.is_staff or not request.user.assigned_temple %}
        <button id="addTempleButton" onclick="addTemple()" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded mt-4">
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î
        </button>
    {% else %}
        <p id="templeWarning" class="text-red-500">‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏ß‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
    {% endif %}


      <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á -->
    <h2 class="text-xl font-bold mb-4 mt-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
    <label for="new_route_temple">‡∏ß‡∏±‡∏î:</label>
    <select id="new_route_temple" class="border p-2 rounded-md w-full">
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î --</option>
    </select>
    <input type="text" id="route_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á" class="border p-2 rounded-md">
    <input type="time" id="route_start_time" class="border p-2 rounded-md">
    <button onclick="addRoute()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4">
      ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    </button>
    <h2 class="text-xl font-bold mb-4 mt-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î</h2>
    <div id="temple_list" class="space-y-2"></div> 
  </div>
  <!-- ‚úÖ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
  <div id="map" class="w-full sm:w-[800px] h-[500px] border border-black mt-6"></div>

  <div class="bg-white shadow-md rounded-lg p-6 mt-6 max-w-2xl">
    <!-- ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î -->
    <label for="temple_select" class="block mb-2 text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î:</label>
    <select id="temple_select" onchange="fetchRoutes()" class="border p-2 rounded-md w-full">
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î --</option>
    </select>

    <!-- ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á -->
    <label for="route_select" class="block mb-2 text-gray-600 mt-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</label>
    <select id="route_select" onchange="fetchCheckpoints()" class="border p-2 rounded-md w-full">
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á --</option>
    </select>
    <h2 class="text-xl font-bold mb-4 mt-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h2>
    <div id="route_list" class="space-y-2"></div> 
  </div>

  <!-- ‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Checkpoints -->
  <div class="bg-white shadow-md rounded-lg p-6 mt-6 max-w-2xl">
    <h2 class="text-xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Checkpoints</h2>

    <table class="w-full mt-4 border-collapse border border-gray-400">
      <thead>
        <tr class="bg-gray-100">
          <th class="border border-gray-400 p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th class="border border-gray-400 p-2">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î</th>
          <th class="border border-gray-400 p-2">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î</th>
          <th class="border border-gray-400 p-2">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
          <th class="border border-gray-400 p-2">‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody id="checkpoints_table"></tbody>
    </table>

    <button onclick="saveAllCheckpoints()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Checkpoints ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>
</div>
</div>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var CURRENT_USER_ID = "{{ request.user.id }}";
    var IS_SUPERUSER = "{{ request.user.is_superuser|yesno:'true,false' }}";
</script>
<script>
let map, currentRouteId;
let checkpointMarkers = [];
let routePolyline = null;




function initMap() {
    map = L.map("map").setView([13.736717, 100.523186], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.on("click", function (e) {
        addCheckpoint(e.latlng.lat, e.latlng.lng);
    });
}
window.onload = function () {
    console.log("‚úÖ Window fully loaded, initializing map...");
    initMap();
    fetchTemples();
    fetchTemplesForEvents(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
};
async function fetchTemplesForEvents() {
    try {
        let response = await fetch("/api/temples/");
        let temples = await response.json();

        let eventSelect = document.getElementById("event_temple_select");
        let filterSelect = document.getElementById("event_temple_filter");

        eventSelect.innerHTML = filterSelect.innerHTML = `<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î --</option>`;

        temples.forEach(temple => {
            let option = document.createElement("option");
            option.value = temple.id;
            option.textContent = temple.name;
            eventSelect.appendChild(option);
            filterSelect.appendChild(option.cloneNode(true));
        });

    } catch (error) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ:", error);
    }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà
document.getElementById("addEventForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    let templeId = document.getElementById("event_temple_select").value;
    let date = document.getElementById("event_date").value;
    let type = document.getElementById("event_type").value;
    let description = document.getElementById("event_description").value;
    let isCanceled = document.getElementById("is_canceled").checked;

    let response = await fetch("/api/events/add/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            temple_id: templeId,
            date: date,
            event_type: type,
            description: description,
            is_canceled: isCanceled
        })
    });

    let result = await response.json();

    if (response.ok) {
        alert(result.message);
        fetchEvents(templeId); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î event ‡πÉ‡∏´‡∏°‡πà
    } else {
        alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ: ${result.error}`);
    }
});

document.addEventListener("DOMContentLoaded", async function() {
    let response = await fetch("/api/user-info/");
    let user = await response.json();

    if (user.is_staff && user.assigned_temple) {
        document.getElementById("addTempleButton").style.display = "none";
        document.getElementById("templeWarning").style.display = "block";
    }
});

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
async function fetchEvents() {
    let templeId = document.getElementById("event_temple_filter").value;
    if (!templeId) return;

    try {
        // ‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô
        let eventList = document.getElementById("event_list");
        eventList.innerHTML = "";

        // ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        let response = await fetch(`/api/events/${templeId}/`);
        let events = await response.json();

        if (events.length === 0) {
            eventList.style.display = "none";
        } else {
            eventList.style.display = "block";
            events.forEach(event => {
                let item = document.createElement("li");
                item.innerHTML = `
                    <span>
                        ${event.date} - 
                        ${event.event_type === "buddhist_day" ? "üìå ‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞" : ""}
                        ${event.event_type === "special_event" ? "‚ö†Ô∏è ‡∏Å‡∏¥‡∏à‡∏ô‡∏¥‡∏°‡∏ô‡∏ï‡πå" : ""}
                        ${event.event_type === "weather" ? "üåßÔ∏è ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®" : ""}
                        ${event.description} 
                        ${event.is_canceled ? "(‡∏á‡∏î‡∏ö‡∏¥‡∏ì‡∏ë‡∏ö‡∏≤‡∏ï)" : ""}
                    </span>
                    <button onclick="deleteEvent(${event.id})" class="bg-red-500 text-white px-3 py-1 rounded">
                        ‡∏•‡∏ö
                    </button>
                `;
                eventList.appendChild(item);
            });
        }
    } catch (error) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ:", error);
    }
}

// ‚úÖ ‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
async function deleteEvent(eventId) {
    console.log(`Attempting to delete event with ID: ${eventId}`);

    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ?")) return;

    try {
        let response = await fetch(`/api/events/${eventId}/delete/`, { method: "DELETE" });

        if (response.ok) {
            alert("‚úÖ ‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            fetchEvents(); // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
        } else {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ");
        }
    } catch (error) {
        console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏•‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:", error);
    }
}

async function fetchRoutes() {
    let templeId = document.getElementById("temple_select").value;
    if (!templeId) {
        console.log("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á");
        return;
    }

    try {
        let response = await fetch(`/api/routes/${templeId}/`);
        if (!response.ok) throw new Error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ");

        let routes = await response.json();
        let select = document.getElementById("route_select");
        let routeList = document.getElementById("route_list");

        select.innerHTML = `<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á --</option>`;
        routeList.innerHTML = "";

        routes.forEach(route => {
            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Dropdown
            let option = document.createElement("option");
            option.value = route.id;
            option.textContent = `${route.name} (‡πÄ‡∏£‡∏¥‡πà‡∏° ${route.start_time})`;
            select.appendChild(option);

            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            let routeItem = document.createElement("div");
            routeItem.classList.add("border", "p-3", "rounded-md", "mt-2", "bg-gray-50");

            routeItem.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                    <div>
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</label>
                        <input type="text" value="${route.name}" id="route_name_${route.id}" class="border p-1 rounded-md w-full">
                        ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°:
                        <input type="time" value="${route.start_time}" id="start_time_${route.id}" class="border p-1 rounded-md ml-2">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateStartTime(${route.id})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
                        </button>
                        <button onclick="deleteRoute(${route.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            ‡∏•‡∏ö
                        </button>
                    </div>
                </div>
            `;
            routeList.appendChild(routeItem);
        });


        console.log("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", routes);
    } catch (error) {
        console.error("‚ùå Error:", error);
    }
}

async function fetchTemples() {
    try {
        let response = await fetch("/api/temples/");
        let temples = await response.json();

        let select = document.getElementById("temple_select");
        let selectNewRoute = document.getElementById("new_route_temple");
        let templeList = document.getElementById("temple_list");

        select.innerHTML = `<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î --</option>`;
        selectNewRoute.innerHTML = `<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î --</option>`;
        templeList.innerHTML = "";

        temples.forEach(temple => {
            let option = document.createElement("option");
            option.value = temple.id;
            option.textContent = temple.name;
            select.appendChild(option);
            selectNewRoute.appendChild(option.cloneNode(true));

            let templeItem = document.createElement("div");
            templeItem.classList.add("flex", "justify-between", "items-center", "border", "p-2", "rounded-md", "mt-2");

            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏î)
            let deleteButton = "";
            if (temple.created_by == CURRENT_USER_ID || IS_SUPERUSER) {
                deleteButton = `
                    <button onclick="deleteTemple(${temple.id})" 
                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-700">
                        ‡∏•‡∏ö
                    </button>`;
            }

            templeItem.innerHTML = `<span>${temple.name}</span> ${deleteButton}`;
            templeList.appendChild(templeItem);
        });
    } catch (error) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏î:", error);
    }
}




async function addTemple() {
    let name = document.getElementById("temple_name").value;
    let location = document.getElementById("temple_location").value || "";

    if (!name) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î");
        return;
    }

    let response = await fetch("/api/temples/add/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            name: name,
            location: location
        })
    });

    if (response.ok) {
        alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        fetchTemples(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
        document.getElementById("temple_name").value = ""; // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï
        document.getElementById("temple_location").value = "";
    } else {
        let errorData = await response.json();
        alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ: ${errorData.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"}`);
    }
}


async function deleteTemple(templeId) {
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ?")) return;

    await fetch(`/api/temples/${templeId}/delete/`, { method: "DELETE" });
    alert("‚úÖ ‡∏•‡∏ö‡∏ß‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    fetchTemples();
}
async function addRoute() {
    let templeId = document.getElementById("new_route_temple").value;
    let name = document.getElementById("route_name").value;
    let startTime = document.getElementById("route_start_time").value;

    if (!templeId || !name || !startTime) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
        return;
    }

    let response = await fetch("/api/routes/add/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ temple_id: templeId, name: name, start_time: startTime })
    });

    if (response.ok) {
        alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        fetchRoutes(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        document.getElementById("route_name").value = ""; // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï
        document.getElementById("route_start_time").value = "";
    } else {
        let errorData = await response.json();
        alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${errorData.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"}`);
    }
}
async function deleteRoute(routeId) {
    if (!confirm("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ?")) return;

    let response = await fetch(`/api/routes/${routeId}/delete/`, {
        method: "DELETE"
    });

    let data = await response.json();
    if (response.ok) {
        alert("‚úÖ ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        fetchRoutes(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    } else {
        alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"}`);
    }
}

async function fetchCheckpoints() {
    let routeId = document.getElementById("route_select").value;
    if (!routeId) {
        currentRouteId = null;
        return;
    }

    currentRouteId = routeId;

    let response = await fetch(`/api/routes/${routeId}/checkpoints/`);
    let checkpoints = await response.json();

    let table = document.getElementById("checkpoints_table");
    table.innerHTML = "";
    checkpointMarkers.forEach(({ marker }) => map.removeLayer(marker));
    checkpointMarkers = [];

    checkpoints.forEach(cp => {
        addCheckpointOnMap(cp.lat, cp.lon, cp.name || `Checkpoint ${checkpointMarkers.length + 1}`, cp.id, cp.travel_time);
    });

    updateRoutePolyline();

    // ‚úÖ **‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á Checkpoint ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á**
    if (checkpointMarkers.length > 0) {
        let firstCheckpoint = checkpointMarkers[0].marker.getLatLng();
        map.setView(firstCheckpoint, 15); // üîπ ‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å ‡∏£‡∏∞‡∏î‡∏±‡∏ö 15
    }
}


async function addCheckpoint(lat, lon) {
    if (!currentRouteId) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Checkpoint");
        return;
    }

    let name = `Checkpoint ${checkpointMarkers.length + 1}`; // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    let travelTime = 5;

    let response = await fetch(`/api/routes/${currentRouteId}/checkpoints/add/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, lat, lon, travel_time: travelTime })
    });

    if (response.ok) {
        let checkpoint = await response.json();
        addCheckpointOnMap(lat, lon, checkpoint.name, checkpoint.id, travelTime);
    } else {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° Checkpoint ‡πÑ‡∏î‡πâ");
    }
}


function addCheckpointOnMap(lat, lon, name, id, travel_time) {
    if (!name) { 
        name = `Checkpoint ${checkpointMarkers.length + 1}`; // 
    }

    let marker = L.marker([lat, lon], {
        draggable: true,
        icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/3448/3448577.png",
            iconSize: [30, 30]
        })
    }).addTo(map);

    marker.bindTooltip(name, { permanent: true, direction: "top" }).openTooltip();

    marker.on("dragend", function (e) {
        let newLatLng = e.target.getLatLng();
        updateCheckpointPosition(id, newLatLng.lat, newLatLng.lng);
        updateCheckpointTable(id, newLatLng.lat, newLatLng.lng);
        updateRoutePolyline();
    });

    checkpointMarkers.push({ marker, id, name, lat, lon, travel_time });

    addCheckpointToTable(id, name, lat, lon, travel_time);

    updateRoutePolyline(); 
}


async function updateCheckpointPosition(id, lat, lon) {
    let response = await fetch(`/api/checkpoints/${id}/update/`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat, lon })
    });

    if (response.ok) {
        console.log(`‚úÖ Checkpoint ${id} updated to new position: ${lat}, ${lon}`);
    }
}

function updateCheckpointTable(id, newLat, newLon) {
    let row = document.querySelector(`tr[data-id="${id}"]`);
    if (row) {
        row.querySelector("td:nth-child(2) input").value = newLat;
        row.querySelector("td:nth-child(3) input").value = newLon;
    }
}
function addCheckpointToTable(id, name, lat, lon, travel_time) {
    let table = document.getElementById("checkpoints_table");
    let row = document.createElement("tr");
    row.dataset.id = id || "";

    row.innerHTML = `
        <td class="border border-gray-400 p-2"><input type="text" value="${name}" class="border p-1 rounded-md"></td>
        <td class="border border-gray-400 p-2"><input type="text" value="${lat}" class="border p-1 rounded-md"></td>
        <td class="border border-gray-400 p-2"><input type="text" value="${lon}" class="border p-1 rounded-md"></td>
        <td class="border border-gray-400 p-2"><input type="number" value="${travel_time}" min="0" class="border p-1 rounded-md"></td>
        <td class="border border-gray-400 p-2">
            <button onclick="deleteCheckpoint(${id})" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">
                ‡∏•‡∏ö
            </button>
        </td>
    `;
    table.appendChild(row);
}

async function deleteCheckpoint(id) {
    await fetch(`/api/checkpoints/${id}/delete/`, { method: "DELETE" });

    let index = checkpointMarkers.findIndex(cp => cp.id === id);
    if (index !== -1) {
        map.removeLayer(checkpointMarkers[index].marker);
        checkpointMarkers.splice(index, 1);
    }
    fetchCheckpoints();
}

function updateRoutePolyline() {
    if (routePolyline) {
        map.removeLayer(routePolyline); // ‚úÖ ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
    }

    let routeCoordinates = checkpointMarkers.map(cp => [cp.marker.getLatLng().lat, cp.marker.getLatLng().lng]);

    if (routeCoordinates.length > 1) {
        routePolyline = L.polyline(routeCoordinates, { color: 'blue', weight: 4 }).addTo(map);
    }
}
async function saveAllCheckpoints() {
    if (!currentRouteId) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Checkpoints");
        return;
    }

    let tableRows = document.querySelectorAll("#checkpoints_table tr");
    let updatedCheckpoints = Array.from(tableRows).map((row, index) => {
        let id = row.dataset.id ? parseInt(row.dataset.id) : null;
        let name = row.querySelector("td:nth-child(1) input").value;
        let lat = parseFloat(row.querySelector("td:nth-child(2) input").value);
        let lon = parseFloat(row.querySelector("td:nth-child(3) input").value);
        let travel_time = parseInt(row.querySelector("td:nth-child(4) input").value);

        // ‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ travel_time ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö
        if (travel_time < 0 || isNaN(travel_time)) {
            alert(`‚ùå ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${index + 1})`);
            throw new Error("Invalid travel_time");
        }

        return { id, name, lat, lon, travel_time };
    });

    for (let cp of updatedCheckpoints) {
        if (cp.id) {
            await fetch(`/api/checkpoints/${cp.id}/update/`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(cp)
            });
        } else {
            let response = await fetch(`/api/routes/${currentRouteId}/checkpoints/add/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(cp)
            });
            let savedCheckpoint = await response.json();
            cp.id = savedCheckpoint.id;
        }
    }

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Checkpoints ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    fetchCheckpoints();
}
async function updateStartTime(routeId) {
    const newName = document.getElementById(`route_name_${routeId}`).value;

    if (!newName) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á");
        return;
    }

    let response = await fetch(`/api/routes/${routeId}/update/`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName })
    });

    let result = await response.json();

    if (response.ok) {
        alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        fetchRoutes();
    } else {
        alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ: ${result.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"}`);
    }
}

</script>

{% endblock %}
