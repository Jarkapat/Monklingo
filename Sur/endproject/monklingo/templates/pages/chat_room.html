{% extends 'base/base_chat.html' %}

{% block main %}
<!-- Main Content -->
<main class="flex-grow p-6 bg-white">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-[#E2A226] mb-6 baloo-bhai">ห้องแชท: {{ chatroom.name }}</h1>

        <!-- Message List -->
        <div class="p-4 rounded-lg shadow overflow-y-auto h-[500px] mb-6">
            <ul class="space-y-4" id="message-list">
                {% for message in messages %}
                <li class="flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
                    <div class="{% if message.sender == request.user %}bg-blue-400 text-white{% else %}bg-gray-200 text-black{% endif %} p-4 rounded-lg shadow-md max-w-xs">
                        <strong class="block text-sm">
                            {% if message.sender == request.user %}คุณ{% else %}{{ message.sender.username }}{% endif %}
                        </strong>
                        <p class="mt-2">{{ message.content }}</p>
                        {% if message.image %}
                        <img src="{{ message.image.url }}" alt="Image" class="w-32 h-auto rounded-lg shadow mt-2">
                        {% endif %}
                        {% if message.file %}
                        <a href="{{ message.file.url }}" class="hover:underline text-blue-500 mt-2 block" download>ดาวน์โหลดไฟล์: {{ message.file.name }}</a>
                        {% endif %}
                        <small class="block text-xs mt-2">{{ message.timestamp|date:"d/m/Y H:i" }}</small>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Message Form -->
        <form method="POST" enctype="multipart/form-data" class="bg-gray-100 p-4 rounded-lg shadow-lg">
            {% csrf_token %}
            <textarea name="content" placeholder="พิมพ์ข้อความ..." rows="3" class="w-full border rounded-lg p-2 mb-4"></textarea>
            <div class="flex items-center space-x-4">
                <label for="image-upload" class="cursor-pointer"><i class="fi fi-rr-picture text-blue-500 text-2xl hover:text-blue-700"></i></label>
                <input id="image-upload" type="file" name="image" accept="image/*" class="hidden">
                <label for="file-upload" class="cursor-pointer"><i class="fi fi-rr-file text-green-500 text-2xl hover:text-green-700"></i></label>
                <input id="file-upload" type="file" name="file" class="hidden">
            </div>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 mt-4">ส่งข้อความ</button>
        </form>
    </div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        const messageList = document.querySelector("#message-list");
        const roomId = {{ chatroom.id }};

        async function fetchMessages() {
            try {
                const response = await fetch(`/chat/${roomId}/messages/`);
                if (response.ok) {
                    const messages = await response.json();
                    messageList.innerHTML = "";
                    messages.forEach(message => {
                        const messageHTML = `
                            <li class="flex ${message.sender === "{{ request.user.username }}" ? 'justify-end' : 'justify-start'}">
                                <div class="${message.sender === "{{ request.user.username }}" ? 'bg-blue-400 text-white' : 'bg-gray-200 text-black'} p-4 rounded-lg shadow-md max-w-xs">
                                    <strong>${message.sender === "{{ request.user.username }}" ? 'คุณ' : message.sender}</strong>
                                    <p class="mt-2">${message.content || ''}</p>
                                    ${message.image ? `<img src="${message.image}" class="w-32 h-auto rounded-lg mt-2">` : ''}
                                    ${message.file ? `<a href="${message.file}" class="text-blue-500 hover:underline mt-2 block">ดาวน์โหลดไฟล์</a>` : ''}
                                    <small class="block text-xs mt-2">${message.timestamp}</small>
                                </div>
                            </li>
                        `;
                        messageList.innerHTML += messageHTML;
                    });
                }
            } catch (error) {
                console.error("Error fetching messages:", error);
            }
        }

        setInterval(fetchMessages, 3000); // Refresh messages every 3 seconds

        form.onsubmit = async function (e) {
            e.preventDefault();
            const formData = new FormData(form);

            const response = await fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                },
            });

            if (response.ok) {
                form.reset();
                fetchMessages();
            } else {
                alert("เกิดข้อผิดพลาด: ไม่สามารถส่งข้อความได้");
            }
        };
    });
</script>
{% endblock %}
