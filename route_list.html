{% extends 'routes/base.html' %}
{% block main %}

<div class="flex flex-col ml-10">
  <h1 class="text-left text-2xl my-4 noto">ข้อมูลเส้นทาง</h1>
  <div id="mapA" class="w-full sm:w-[1200px] h-[600px] border border-black mb-20"></div>
  <div id="mapB" class="w-full sm:w-[1200px] h-[400px] border border-black mb-20"></div>
  <div id="mapC" class="w-full sm:w-[1200px] h-[400px] border border-black mb-20"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
  // ข้อมูลเส้นทาง
  const routesData = {
    A: {
      start: [15.120971, 104.889216],
      waypoints: [
        { lat: 15.1215, lng: 104.8950, speed: 500 },
        { lat: 15.1220, lng: 104.8970, speed: 300 }
      ],
      end: [15.120971, 104.889216],
      checkpoints: [
        { lat: 15.1210, lng: 104.8920, name: "ตลาดเช้า", reached: false },
        { lat: 15.1223, lng: 104.8965, name: "วัดพระใหญ่", reached: false }
      ]
    },
    B: {
      start: [15.1300, 104.9000],
      waypoints: [
        { lat: 15.1310, lng: 104.9050, speed: 400 },
        { lat: 15.1320, lng: 104.9100, speed: 600 }
      ],
      end: [15.1330, 104.9150],
      checkpoints: [
        { lat: 15.1305, lng: 104.9025, name: "จุดพักน้ำ", reached: false },
        { lat: 15.1325, lng: 104.9125, name: "วัดกลางน้ำ", reached: false }
      ]
    },
    C: {
      start: [15.1400, 104.9200],
      waypoints: [
        { lat: 15.1410, lng: 104.9250, speed: 300 },
        { lat: 15.1420, lng: 104.9280, speed: 500 }
      ],
      end: [15.1430, 104.9300],
      checkpoints: [
        { lat: 15.1405, lng: 104.9225, name: "ตลาดใหม่", reached: false },
        { lat: 15.1425, lng: 104.9295, name: "วัดใหญ่", reached: false }
      ]
    }
  };

  // ฟังก์ชันสร้างแผนที่และจัดการ marker
  function initializeMap(mapId, routeData) {
    const map = L.map(mapId).setView(routeData.start, 13);

    // เพิ่ม Tile Layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marker สำหรับการเคลื่อนที่
    const marker = L.marker(routeData.start).addTo(map);

    // เพิ่มจุด Checkpoint บนแผนที่
    routeData.checkpoints.forEach(checkpoint => {
      const checkpointMarker = L.marker([checkpoint.lat, checkpoint.lng], {
        icon: L.icon({
          iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-red.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34]
        })
      })
        .addTo(map)
        .bindPopup(`${checkpoint.name} (ยังไม่ถึง)`);

      checkpoint.marker = checkpointMarker;
    });

    // สร้างเส้นทาง
    const waypoints = [
      L.latLng(routeData.start),
      ...routeData.waypoints.map(point => L.latLng(point.lat, point.lng)),
      L.latLng(routeData.end)
    ];

    const speeds = routeData.waypoints.map(point => point.speed);

    L.Routing.control({
      waypoints: waypoints,
      routeWhileDragging: false,
      createMarker: function () { return null; } // ไม่สร้าง marker อัตโนมัติ
    })
      .on('routesfound', function (e) {
        const coordinates = e.routes[0].coordinates.map(coord => [coord.lat, coord.lng]);
        animateMarker(coordinates, marker, speeds, routeData.checkpoints);
      })
      .addTo(map);
  }

  // ฟังก์ชันเคลื่อนที่ marker พร้อมอัปเดต Checkpoint
  function animateMarker(coordinates, marker, speeds, checkpoints) {
    let index = 0;

    function move() {
      if (index < coordinates.length - 1) {
        index++;
        marker.setLatLng(coordinates[index]);

        // ตรวจสอบว่า marker ถึง Checkpoint หรือยัง
        checkpoints.forEach(checkpoint => {
          const distance = L.latLng(checkpoint.lat, checkpoint.lng).distanceTo(marker.getLatLng());
          if (distance < 20 && !checkpoint.reached) {
            checkpoint.reached = true;
            checkpoint.marker.bindPopup(`${checkpoint.name} (ถึงแล้ว)`).openPopup();
          }
        });

        setTimeout(move, speeds[index - 1] || 300);
      }
    }

    move();
  }

  // เรียกใช้ฟังก์ชันสำหรับแต่ละแผนที่
  initializeMap('mapA', routesData.A);
  initializeMap('mapB', routesData.B);
  initializeMap('mapC', routesData.C);
</script>


{% endblock %}
