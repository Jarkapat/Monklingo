{% extends 'routes/base.html' %}
{% block main %}

<div class="flex flex-col ml-10">
  <h1 class="text-left text-2xl my-4 noto">ข้อมูลเส้นทาง</h1>
  <div id="mapA" class="w-full sm:w-[1200px] h-[600px] border border-black mb-20"></div>
  <div id="mapB" class="w-full sm:w-[1200px] h-[400px] border border-black mb-20"></div>
  <div id="mapC" class="w-full sm:w-[1200px] h-[400px] border border-black mb-20"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
  // ฟังก์ชันที่ดึงข้อมูลเส้นทางจาก API ของ Django
  function fetchRoutes() {
    fetch('/get-routes/')  // URL ที่จะดึงข้อมูลจาก API
      .then(response => response.json())
      .then(routes => {
        routes.forEach(route => {
          initializeMap(route);
        });
      })
      .catch(error => console.error("Error fetching routes:", error));
  }

  // ฟังก์ชันในการสร้างแผนที่และเส้นทาง
  function initializeMap(routeData) {
    const map = L.map('map').setView(routeData.geometry[0], 13); // กำหนดแผนที่ให้แสดงจุดเริ่มต้น

    // เพิ่ม Tile Layer จาก OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // สร้างเส้นทางโดยใช้ข้อมูล geometry
    const waypoints = [
      L.latLng(routeData.geometry[0]),  // จุดเริ่มต้น
      ...routeData.geometry.slice(1).map(point => L.latLng(point)), // เพิ่ม waypoint
    ];

    const speeds = routeData.checkpoints.map(cp => cp.speed);

    // สร้าง Routing Control และแสดงเส้นทาง
    L.Routing.control({
      waypoints: waypoints,
      routeWhileDragging: false,
      createMarker: function () { return null; } // ไม่สร้าง marker อัตโนมัติ
    }).on('routesfound', function (e) {
      const coordinates = e.routes[0].coordinates.map(coord => [coord.lat, coord.lng]);
      animateMarker(coordinates, map, routeData.checkpoints, speeds); // เริ่มการเคลื่อนที่ของ marker
    }).addTo(map);

    // สร้าง markers สำหรับ Checkpoints
    routeData.checkpoints.forEach(checkpoint => {
      const checkpointMarker = L.marker([checkpoint.location[1], checkpoint.location[0]], {
        icon: L.icon({
          iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-red.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34]
        })
      }).addTo(map).bindPopup(`${checkpoint.name} (ยังไม่ถึง)`);
      
      checkpoint.marker = checkpointMarker; // เก็บข้อมูลของ marker
    });
  }

  // ฟังก์ชันเคลื่อนที่ marker
  function animateMarker(coordinates, map, checkpoints, speeds) {
    let index = 0;
    const marker = L.marker(coordinates[0]).addTo(map);  // สร้าง marker ที่จุดเริ่มต้น

    function move() {
      if (index < coordinates.length - 1) {
        index++;
        marker.setLatLng(coordinates[index]); // อัปเดตตำแหน่งของ marker

        // ตรวจสอบว่า marker ถึง checkpoint หรือยัง
        checkpoints.forEach(checkpoint => {
          const distance = L.latLng(checkpoint.location[1], checkpoint.location[0]).distanceTo(marker.getLatLng());
          if (distance < 20 && !checkpoint.reached) {
            checkpoint.reached = true;
            checkpoint.marker.bindPopup(`${checkpoint.name} (ถึงแล้ว)`).openPopup();
          }
        });

        setTimeout(move, speeds[index - 1] || 300); // ปรับเวลาเดินตามความเร็ว
      }
    }

    move(); // เริ่มการเคลื่อนที่
  }

  // เรียกใช้ฟังก์ชันเมื่อเพจโหลด
  fetchRoutes();  // เรียก API เพื่อดึงข้อมูลเส้นทาง
</script>


{% endblock %}